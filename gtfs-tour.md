この文書は、[帷子川書房日誌のエントリ「横浜市営バス trip_id の歩き方」](https://katabira.hatenablog.com/entry/2022/03/05/000012)の内容を再構成および加筆修正したものです。

> [!Warning]
> 本ドキュメントの記載内容には非公式で独自研究なものを多く含みます。

---

# 横浜市営バス trip_id の歩き方 
横浜市営バスの`trip_id`を扱う際に解析などで得た情報をまとめておきます。

## オープンデータ
本内容は、公共交通オープンデータセンターにおいて提供されるデータを使用およびその内容に沿って書いています。

- [公共交通オープンデータ協議会 | オープンデータで新しい公共交通サービスを](https://www.odpt.org/)

データフォーマットは、GTFSリアルタイム v2.0 / データ構造は `gtfs-realtime.proto` を使用しています

- [動的バス情報フォーマット（GTFSリアルタイム）ガイドライン](https://www.gtfs.jp/developpers-guide/gtfs-realtime_guidelines.html)


## 注意事項
上記以外の部分はすべて管理人の独自研究によるもののため、誤りやアップデートによる仕様相違を含む可能性があります。問い合わせ等は管理人までご連絡ください。

---

# はじめに
## きっかけ 

　色々勢いでやってきたけどそろそろ整理しておかないと将来の自分が困りそうになると感じたので少しずつ文字化を。本当は体系立てて全部書ければ良いんだけど時間に制約があるし、それなら書けるところから書いてあとでまとめればいいんじゃないのというコンセプト。無理せずのんびりやりたいところ。


　ということで横浜市交通局 横浜市営バスの`GTFS-RT`や`GTFS-JP`で取得出来るデータから、`trip_id`のお話。
`GTFS-RT`はリアルタイムデータ、`GTFS-JP`は静的データで、それぞれにさまざまなデータが詰まっています。
その中でも最も重要と言っても過言ではないのが`trip_id`。日本語訳するとなんでしょうね。行路IDでしょうかね。
`trip_id`は単一のトリップインスタンスに設定され（ると書いてあり）ます。`trip_id`はそういう名前なだけで、その中身は事業者ごとに違うはずです。
（「はず」というのは、横浜市交通局以外の GTFS-xx を触ったことがないので…。）

普通に考えると「枠は用意してあるので事業者ごとに好きなのを設定する」のがあり方としては正しそうな気がします。
なので、横浜市交通局の横浜市営バスの`GTFS`の`trip-id`に限定した話で進めていきます。

---

# trip_id を見てみる

例のために2つほどtrip_idを出します。作為的に抽出しました。

> ① 29204_03202112298059A00308
> ② 10708_10202112296107PC00102

こんな感じで設定されていますので、まずはこれを読み解かないと始まりません。公式の定義は公開されていません。
この文字列内に様々なデータがありますが、ほぼ固定長というか一部可変長で扱うのが簡単です。（めんどくさいので固定長にしてほしかった。）

横浜市営バスのマニアの人なら手当たり次第区切っていくうちに行路に関係あるデータを想像していくとなんとなく当てはまってることかと思います。
ということでまずは①をそれっぽくバラします。

`292` `04` `_` `03` `20211229` `8` `059` `A` `003` `08`

こうなります。これをそれぞれ見ていきます。
各項目の名称はすべて、このドキュメントでの便宜上のものです。

| 値       | 長さ   | 説明                                      | 関連する静的データ                  |
|----------|--------|-------------------------------------------|-------------------------------------|
| 292      | 3桁    | 系統番号。系統パタン(5桁)として定義あり   | `routes.txt` `routes_jp.txt`        |
| 04       | 2桁    | 子系統番号。系統パタン(5桁)として定義あり | `routes.txt` `routes_jp.txt`        |
| _        | 1桁    | アンダースコア固定                        |                                     |
| 03       | 2桁    | 営業所コード。静的データに定義あり        | `office_jp.txt`                     |
| 20211229 | 8桁    | ダイヤ改正日 (yyyyMMdd)                   | `calendar.txt` `calendar_dates.txt` |
| 8        | 1桁    | 曜日コード                                |                                     |
| 059      | 3桁    | 交番（系統）                              | `routes.txt` `routes_jp.txt`        |
| A        | 1～2桁 | 交番（種別）                              | `routes.txt` `routes_jp.txt`        |
| 003      | 3桁    | 交番（通番）                              | `routes.txt` `routes_jp.txt`        |
| 08       | 2桁    | 山の連番                                  |

## 系統パタン（系統番号+子系統番号）
系統番号と子系統番号は繋げるとお馴染みの系統パタン(5桁)になります。
子系統番号を00=A,01=A,02=B,03=B,04=C,... 偶数奇数の1セットでアルファベットに変換してやると、子系統記号が出来上がります。今回は `29204` なので `292C`。292系統Cですね。

## 営業所コード
営業所コードは2桁で、各営業所+本局が定義されています。上の例でもわかりますが、03は浅間町、10は港南です。

| 営業所コード | 営業所名                   |
|-------------:|----------------------------|
|           00 | 本局                       |
|           01 | 保土ケ谷営業所             |
|           02 | 若葉台営業所               |
|           03 | 浅間町営業所               |
|           04 | 緑 または 不明             |
|           05 | NT または 緑 または 不明   |
|           06 | 磯子 または NT または 不明 |
|           07 | 不明 または 磯子           |
|           08 | 滝頭営業所                 |
|           09 | 本牧営業所                 |
|           10 | 港南営業所                 |
|           11 | 野庭営業所                 |
|           12 | 港北営業所                 |
|           13 | 鶴見営業所                 |
|           21 | 開発磯子                   |
|           22 | 開発緑                     |

04～07 は、緑営業所・港北ニュータウン営業所・磯子営業所の順で入りますが、枠が4つのところに3つなので確定できません。残り1つの「不明」が入る位置も確定できないため、4通りの可能性があります。

順序はここのものを基準にしています。 → [市営バス　営業所別系統路線図](https://web.archive.org/web/20051102013712/http://www.city.yokohama.jp:80/me/koutuu/bus/keitouzu.html)

空いているところには以前存在した営業所が入るのか、それとも派出所が入っていたのかも不明です。
野庭営業所に関しては空き番号と前後の組み合わせがここしかなかったため確定して（いると思って）います。

## 曜日コード

曜日コードは1～9が設定されます。
1桁なので0の可能性もあると思いますが、2023年11月現在で0が入っているのは見たことがありません。


| 曜日コード | 表示  |    主な用途     |
| ---------- | ----- | --------------- |
| 0          | [曜0] | 使用履歴なし    |
| 1          | 平    | 平日ダイヤ      |
| 2          | 土    | 土曜ダイヤ      |
| 3          | 休    | 休日ダイヤ      |
| 4          | [曜4] | 平日特別ダイヤ1 |
| 5          | [曜5] | 土曜特別ダイヤ1 |
| 6          | [曜6] | 休日特別ダイヤ1 |
| 7          | [曜7] | 平日特別ダイヤ2 |
| 8          | [曜8] | 土曜特別ダイヤ2 |
| 9          | [曜9] | 休日特別ダイヤ2 |

1=平、2=土、3=休、がほぼ固定で、4以降は特別ダイヤのときに使われているようです。
4と7が特平、5と8が特土、6と9が特休、で使われることが多いです。が、確定ソースがないので [曜N] としています。
夏休みの夏季ダイヤや年末年始は恒例ですが、2021年のオリンピックに関して「港町（仮設）」停留所を使用した迂回運転の際も4以降の曜日コードが使われていました。


## 交番

交番は3つまとめると馴染みのある `059A003` になったりします。0埋めされた `59A3` ダイヤです。
厄介なことに、②のパターンがここで登場します。数字はゼロ埋めするのに種別記号は長さ可変なので、`A`,`P`,`M`ダイヤなどのときは記号が1桁になり、`AC`,`PC`,`AO`,`PO`みたいなときは記号が2桁になります。それに伴って `trip_id` の長さも変わってしまいます。
`A`=01、`AC`=02、`P`=03、`PC`=04、みたいなコード体系もあるらしいのですが、オープンデータでは使用していないのと確実なソースが手元にないのでここでは除外します。


## 山

山は起点から終点までの1運行を表します。車庫から始発停留所までも1山です。そういうところは回送が設定されているようです。
ダイヤ／交番一覧で横浜駅前着だと山番号が2つ飛んでいるところがあるのですが、これはおそらく内部的には「横東→横東BP」と「横東BP→横東」の2つが設定されていると思われます。実際のところ、回送が設定されている経路コードが多数存在します（経路コードながらコード体系が違うため、HamaShabanでは回送コードと呼んでいます）。


---

# スタフ

手持ちにあったものを例にしますので系統は全然違いますが、それぞれこんな感じで該当します。

![スタフ](.\images/dia_staff.jpg)


---

# 余談
ダイヤ／交番一覧ではページ内リンクや直リンのために、trip_id から取得できる値を使ってユニークな id 設定をシステマチックに生成しています。


---

# 関連リンク

- [横浜市営バス ダイヤ／交番一覧](https://katabira.sakura.ne.jp/hamashaban/dia/)


---
